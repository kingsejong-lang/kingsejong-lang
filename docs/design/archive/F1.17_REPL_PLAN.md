# F1.17: REPL êµ¬í˜„ ê³„íš

> **Feature**: REPL (Read-Eval-Print Loop)
> **ìš°ì„ ìˆœìœ„**: HIGH
> **ìƒíƒœ**: ğŸ“ ê³„íš
> **ì‘ì„±ì¼**: 2025-11-09

## ê°œìš”

KingSejong ì–¸ì–´ì˜ ëŒ€í™”í˜• ì‹¤í–‰ í™˜ê²½ (REPL)ì„ êµ¬í˜„í•©ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì½”ë“œë¥¼ í•œ ì¤„ì”© ì…ë ¥í•˜ê³  ì¦‰ì‹œ ì‹¤í–‰ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ ì œê³µí•©ë‹ˆë‹¤.

## ëª©í‘œ

- ëŒ€í™”í˜• í”„ë¡¬í”„íŠ¸ ì œê³µ
- í‘œí˜„ì‹ ì¦‰ì‹œ í‰ê°€ ë° ê²°ê³¼ ì¶œë ¥
- ì„¸ì…˜ ë™ì•ˆ ë³€ìˆ˜ ìƒíƒœ ìœ ì§€
- í•œê¸€ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
- ì‚¬ìš©ì ì¹œí™”ì ì¸ ì¸í„°í˜ì´ìŠ¤

## í•µì‹¬ ê¸°ëŠ¥

### 1. ê¸°ë³¸ REPL ë£¨í”„

```
>>> ì •ìˆ˜ x = 10
>>> x
10
>>> ì •ìˆ˜ y = x + 5
>>> y
15
>>> x + y
25
```

### 2. ì—¬ëŸ¬ ì¤„ ì…ë ¥ ì§€ì›

```
>>> ì •ìˆ˜ í•© = í•¨ìˆ˜(a, b) {
...     ë°˜í™˜ a + b
... }
>>> í•©(3, 7)
10
```

### 3. íŠ¹ìˆ˜ ëª…ë ¹

```
.exit      - REPL ì¢…ë£Œ
.help      - ë„ì›€ë§ í‘œì‹œ
.clear     - ë³€ìˆ˜ ì´ˆê¸°í™”
.vars      - ì •ì˜ëœ ë³€ìˆ˜ ëª©ë¡ í‘œì‹œ
```

### 4. ì—ëŸ¬ ì²˜ë¦¬

```
>>> ì •ìˆ˜ x = 10 / 0
ì—ëŸ¬: 0ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
ìœ„ì¹˜: ë¼ì¸ 1

>>> ì •ì˜ë˜ì§€ì•Šì€ë³€ìˆ˜
ì—ëŸ¬: ì •ì˜ë˜ì§€ ì•Šì€ ì‹ë³„ì: ì •ì˜ë˜ì§€ì•Šì€ë³€ìˆ˜
```

## êµ¬í˜„ ì„¤ê³„

### ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   main.cpp  â”‚ (REPL ëª¨ë“œ ì§„ì…)
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Repl.cpp  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€â”€> Lexer   â”€â”€> Token ìŠ¤íŠ¸ë¦¼
      â”‚
      â”œâ”€â”€> Parser  â”€â”€> AST
      â”‚
      â””â”€â”€> Evaluator â”€â”€> ì‹¤í–‰ ê²°ê³¼
           â””â”€> Environment (ì„¸ì…˜ ìœ ì§€)
```

### íŒŒì¼ êµ¬ì¡°

```cpp
// src/repl/Repl.h
#pragma once

#include "../lexer/Lexer.h"
#include "../parser/Parser.h"
#include "../evaluator/Evaluator.h"
#include "../evaluator/Environment.h"
#include <string>
#include <memory>

namespace kingsejong {
namespace repl {

/**
 * @class Repl
 * @brief KingSejong ëŒ€í™”í˜• ì‹¤í–‰ í™˜ê²½
 */
class Repl
{
public:
    /**
     * @brief REPL ì‹œì‘
     */
    void start();

private:
    /// ì „ì—­ í™˜ê²½ (ì„¸ì…˜ ë™ì•ˆ ìœ ì§€)
    std::shared_ptr<evaluator::Environment> env_;

    /**
     * @brief í”„ë¡¬í”„íŠ¸ í‘œì‹œ
     */
    void printPrompt(bool continuation = false);

    /**
     * @brief ì…ë ¥ ì½ê¸° (ì—¬ëŸ¬ ì¤„ ì§€ì›)
     * @return ì™„ì „í•œ ì…ë ¥ ë¬¸ìì—´, EOFì‹œ ë¹ˆ ë¬¸ìì—´
     */
    std::string readInput();

    /**
     * @brief ì…ë ¥ì´ ì™„ì „í•œì§€ í™•ì¸ (ê´„í˜¸ ë§¤ì¹­)
     * @param input ì…ë ¥ ë¬¸ìì—´
     * @return ì™„ì „í•˜ë©´ true
     */
    bool isComplete(const std::string& input);

    /**
     * @brief ì…ë ¥ í‰ê°€ ë° ì¶œë ¥
     * @param input ì…ë ¥ ë¬¸ìì—´
     */
    void evalAndPrint(const std::string& input);

    /**
     * @brief íŠ¹ìˆ˜ ëª…ë ¹ ì²˜ë¦¬
     * @param input ì…ë ¥ ë¬¸ìì—´
     * @return íŠ¹ìˆ˜ ëª…ë ¹ì´ë©´ true
     */
    bool handleCommand(const std::string& input);

    /**
     * @brief ë„ì›€ë§ ì¶œë ¥
     */
    void printHelp();

    /**
     * @brief í™˜ì˜ ë©”ì‹œì§€ ì¶œë ¥
     */
    void printWelcome();

    /**
     * @brief ë³€ìˆ˜ ëª©ë¡ ì¶œë ¥
     */
    void printVariables();
};

} // namespace repl
} // namespace kingsejong
```

### ì£¼ìš” ë©”ì„œë“œ

#### 1. `start()` - REPL ë©”ì¸ ë£¨í”„

```cpp
void Repl::start()
{
    env_ = std::make_shared<evaluator::Environment>();
    evaluator::Builtin::registerAllBuiltins();

    printWelcome();

    while (true)
    {
        printPrompt();
        std::string input = readInput();

        if (input.empty())  // EOF (Ctrl+D)
        {
            std::cout << "\nì•ˆë…•íˆ ê°€ì„¸ìš”!\n";
            break;
        }

        if (handleCommand(input))
        {
            continue;
        }

        evalAndPrint(input);
    }
}
```

#### 2. `readInput()` - ì—¬ëŸ¬ ì¤„ ì…ë ¥ ì§€ì›

```cpp
std::string Repl::readInput()
{
    std::string line;
    std::string input;

    while (true)
    {
        if (!std::getline(std::cin, line))
        {
            return "";  // EOF
        }

        input += line + "\n";

        if (isComplete(input))
        {
            break;
        }

        printPrompt(true);  // "... " í”„ë¡¬í”„íŠ¸
    }

    return input;
}
```

#### 3. `isComplete()` - ê´„í˜¸ ë§¤ì¹­ ê²€ì‚¬

```cpp
bool Repl::isComplete(const std::string& input)
{
    int braceCount = 0;
    int parenCount = 0;
    int bracketCount = 0;
    bool inString = false;

    for (size_t i = 0; i < input.length(); ++i)
    {
        char ch = input[i];

        if (ch == '"' && (i == 0 || input[i-1] != '\\'))
        {
            inString = !inString;
            continue;
        }

        if (inString) continue;

        if (ch == '{') braceCount++;
        else if (ch == '}') braceCount--;
        else if (ch == '(') parenCount++;
        else if (ch == ')') parenCount--;
        else if (ch == '[') bracketCount++;
        else if (ch == ']') bracketCount--;
    }

    return braceCount == 0 && parenCount == 0 && bracketCount == 0;
}
```

#### 4. `evalAndPrint()` - í‰ê°€ ë° ì¶œë ¥

```cpp
void Repl::evalAndPrint(const std::string& input)
{
    try
    {
        lexer::Lexer lexer(input);
        parser::Parser parser(lexer);
        auto program = parser.parseProgram();

        if (!parser.errors().empty())
        {
            for (const auto& err : parser.errors())
            {
                std::cerr << "íŒŒì„œ ì—ëŸ¬: " << err << "\n";
            }
            return;
        }

        evaluator::Evaluator evaluator(env_);
        auto result = evaluator.evalProgram(program.get());

        // nullì´ ì•„ë‹ˆë©´ ê²°ê³¼ ì¶œë ¥
        if (!result.isNull())
        {
            std::cout << result.toString() << "\n";
        }
    }
    catch (const std::exception& e)
    {
        std::cerr << "ì—ëŸ¬: " << e.what() << "\n";
    }
}
```

#### 5. `handleCommand()` - íŠ¹ìˆ˜ ëª…ë ¹ ì²˜ë¦¬

```cpp
bool Repl::handleCommand(const std::string& input)
{
    std::string trimmed = input;
    // trim whitespace
    trimmed.erase(0, trimmed.find_first_not_of(" \t\n\r"));
    trimmed.erase(trimmed.find_last_not_of(" \t\n\r") + 1);

    if (trimmed == ".exit" || trimmed == ".quit")
    {
        std::cout << "ì•ˆë…•íˆ ê°€ì„¸ìš”!\n";
        exit(0);
    }
    else if (trimmed == ".help" || trimmed == ".ë„ì›€ë§")
    {
        printHelp();
        return true;
    }
    else if (trimmed == ".clear" || trimmed == ".ì´ˆê¸°í™”")
    {
        env_->clear();
        std::cout << "ëª¨ë“  ë³€ìˆ˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n";
        return true;
    }
    else if (trimmed == ".vars" || trimmed == ".ë³€ìˆ˜")
    {
        printVariables();
        return true;
    }

    return false;
}
```

### UI ë””ìì¸

#### í™˜ì˜ ë©”ì‹œì§€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   KingSejong ì–¸ì–´ v0.1.0                â”‚
â”‚   ëŒ€í™”í˜• ì‹¤í–‰ í™˜ê²½ (REPL)                â”‚
â”‚                                         â”‚
â”‚   ë„ì›€ë§: .help ë˜ëŠ” .ë„ì›€ë§             â”‚
â”‚   ì¢…ë£Œ: .exit ë˜ëŠ” Ctrl+D               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### í”„ë¡¬í”„íŠ¸

```
>>> ì •ìˆ˜ x = 10        # ì¼ë°˜ í”„ë¡¬í”„íŠ¸
... }                  # ì—¬ëŸ¬ ì¤„ ì…ë ¥ (continuation)
```

#### ë„ì›€ë§

```
KingSejong REPL ëª…ë ¹ì–´:

  .exit, .quit     - REPL ì¢…ë£Œ
  .help, .ë„ì›€ë§    - ì´ ë„ì›€ë§ í‘œì‹œ
  .clear, .ì´ˆê¸°í™”   - ëª¨ë“  ë³€ìˆ˜ ì´ˆê¸°í™”
  .vars, .ë³€ìˆ˜      - ì •ì˜ëœ ë³€ìˆ˜ ëª©ë¡

í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤:

  Ctrl+D          - REPL ì¢…ë£Œ (EOF)
  Ctrl+C          - í˜„ì¬ ì…ë ¥ ì·¨ì†Œ
```

## main.cpp í†µí•©

```cpp
#include "repl/Repl.h"
#include "evaluator/Builtin.h"
#include <iostream>

int main(int argc, char* argv[])
{
    // ë‚´ì¥ í•¨ìˆ˜ ë“±ë¡
    kingsejong::evaluator::Builtin::registerAllBuiltins();

    if (argc == 1)
    {
        // REPL ëª¨ë“œ
        kingsejong::repl::Repl repl;
        repl.start();
    }
    else if (argc == 2)
    {
        // íŒŒì¼ ì‹¤í–‰ ëª¨ë“œ (F1.18ì—ì„œ êµ¬í˜„)
        std::string filename = argv[1];
        // TODO: executeFile(filename);
    }
    else
    {
        std::cerr << "ì‚¬ìš©ë²•: kingsejong [íŒŒì¼ëª…]\n";
        return 1;
    }

    return 0;
}
```

## í…ŒìŠ¤íŠ¸ ê³„íš

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (tests/ReplTest.cpp)

1. **ê¸°ë³¸ ì…ë ¥/ì¶œë ¥**
   - ì •ìˆ˜ ë¦¬í„°ëŸ´ ì…ë ¥ â†’ ê²°ê³¼ ì¶œë ¥
   - ë³€ìˆ˜ ì„ ì–¸ ë° ì°¸ì¡°
   - í‘œí˜„ì‹ í‰ê°€

2. **ì—¬ëŸ¬ ì¤„ ì…ë ¥**
   - í•¨ìˆ˜ ì •ì˜ (ë¸”ë¡)
   - ì¡°ê±´ë¬¸
   - ë°˜ë³µë¬¸

3. **ë³€ìˆ˜ ìƒíƒœ ìœ ì§€**
   - ì„¸ì…˜ ë™ì•ˆ ë³€ìˆ˜ ìœ ì§€
   - ë³€ìˆ˜ ì¬í• ë‹¹

4. **íŠ¹ìˆ˜ ëª…ë ¹**
   - .clear ë™ì‘ í™•ì¸
   - .vars ì¶œë ¥ í™•ì¸

5. **ì—ëŸ¬ ì²˜ë¦¬**
   - íŒŒì„œ ì—ëŸ¬
   - í‰ê°€ ì—ëŸ¬
   - ì •ì˜ë˜ì§€ ì•Šì€ ë³€ìˆ˜

### í†µí•© í…ŒìŠ¤íŠ¸

ì‹¤ì œ REPL ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:

```
>>> ì •ìˆ˜ í”¼ë³´ë‚˜ì¹˜ = í•¨ìˆ˜(n) {
...     ë§Œì•½ (n <= 1) {
...         ë°˜í™˜ n
...     }
...     ë°˜í™˜ í”¼ë³´ë‚˜ì¹˜(n-1) + í”¼ë³´ë‚˜ì¹˜(n-2)
... }
>>> í”¼ë³´ë‚˜ì¹˜(10)
55
>>> .vars
í”¼ë³´ë‚˜ì¹˜ (í•¨ìˆ˜)
>>> .clear
ëª¨ë“  ë³€ìˆ˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
>>> í”¼ë³´ë‚˜ì¹˜(5)
ì—ëŸ¬: ì •ì˜ë˜ì§€ ì•Šì€ ì‹ë³„ì: í”¼ë³´ë‚˜ì¹˜
```

## ì™„ë£Œ ì¡°ê±´

- [x] Repl.h/cpp êµ¬í˜„
- [x] main.cpp í†µí•© (REPL ëª¨ë“œ)
- [x] ì—¬ëŸ¬ ì¤„ ì…ë ¥ ì§€ì›
- [x] ë³€ìˆ˜ ìƒíƒœ ìœ ì§€
- [x] íŠ¹ìˆ˜ ëª…ë ¹ êµ¬í˜„ (.exit, .help, .clear, .vars)
- [x] ì—ëŸ¬ ì²˜ë¦¬ ë° í‘œì‹œ
- [x] í…ŒìŠ¤íŠ¸ ì‘ì„± ë° í†µê³¼
- [x] ë¬¸ì„œ ì—…ë°ì´íŠ¸

## ë‹¤ìŒ ë‹¨ê³„

F1.17 ì™„ë£Œ í›„:
- **F1.18**: íŒŒì¼ ì‹¤í–‰ ëª¨ë“œ êµ¬í˜„ (main.cppì—ì„œ .ksj íŒŒì¼ ì½ê¸° ë° ì‹¤í–‰)
- **F1.19**: ì˜ˆì œ í”„ë¡œê·¸ë¨ ì‘ì„± (examples/*.ksj)

## ì°¸ê³  ì‚¬í•­

### ê¸°ìˆ ì  ê³ ë ¤ì‚¬í•­

1. **UTF-8 ì…ë ¥ ì²˜ë¦¬**
   - í•œê¸€ ì…ë ¥ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬
   - std::getline() UTF-8 ì•ˆì „

2. **ì‹œê·¸ë„ ì²˜ë¦¬**
   - Ctrl+C ì²˜ë¦¬ (í˜„ì¬ ì…ë ¥ ì·¨ì†Œ, REPL ì¢…ë£Œ ì•ˆ í•¨)
   - Ctrl+D ì²˜ë¦¬ (EOF, ì •ìƒ ì¢…ë£Œ)

3. **í¬ë¡œìŠ¤ í”Œë«í¼**
   - Windows, macOS, Linux ëª¨ë‘ ë™ì‘
   - í„°ë¯¸ë„ ì œì–´ ìµœì†Œí™” (ê¸°ë³¸ std::cin/cout ì‚¬ìš©)

### í–¥í›„ ê°œì„ ì‚¬í•­ (Phase 2+)

- ëª…ë ¹ì–´ íˆìŠ¤í† ë¦¬ (â†‘â†“ í‚¤)
- ìë™ ì™„ì„± (Tab í‚¤)
- êµ¬ë¬¸ í•˜ì´ë¼ì´íŒ…
- ì¤„ í¸ì§‘ ê¸°ëŠ¥ (readline/libedit í†µí•©)
- ë©€í‹°ë¼ì¸ ì—ë””í„° (vi/emacs ëª¨ë“œ)

## êµ¬í˜„ ìˆœì„œ

1. **Step 1**: Repl.h ê¸°ë³¸ êµ¬ì¡° ì‘ì„±
2. **Step 2**: Repl.cpp ê¸°ë³¸ ë£¨í”„ êµ¬í˜„ (ë‹¨ì¼ ë¼ì¸)
3. **Step 3**: ì—¬ëŸ¬ ì¤„ ì…ë ¥ ì§€ì› ì¶”ê°€
4. **Step 4**: íŠ¹ìˆ˜ ëª…ë ¹ êµ¬í˜„
5. **Step 5**: main.cpp í†µí•©
6. **Step 6**: í…ŒìŠ¤íŠ¸ ì‘ì„±
7. **Step 7**: ë¬¸ì„œ ì—…ë°ì´íŠ¸ ë° PR

---

**ì‘ì„±ì**: Claude
**ìµœì¢… ìˆ˜ì •**: 2025-11-09
